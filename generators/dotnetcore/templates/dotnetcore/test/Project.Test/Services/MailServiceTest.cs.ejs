using MimeKit;
using MailKit.Net.Smtp;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using System;
using System.Threading.Tasks;
using JhipsterSampleApplication.Domain.Entities;
using JhipsterSampleApplication.Domain.Services.Interfaces;
using JhipsterSampleApplication.Infrastructure.Configuration;

namespace JhipsterSampleApplication.Domain.Services;

public class MailService : IMailService
{
    private readonly SecuritySettings _settings;
    private readonly ILogger<MailService> _logger;

    // Test hook for unit testing
    internal Func<MimeMessage, Task> TestAction { get; set; }

    public MailService(IOptions<SecuritySettings> settings, ILogger<MailService> logger)
    {
        _settings = settings.Value;
        _logger = logger;
    }

    private async Task SendEmailAsync(string to, string subject, string htmlContent)
    {
        var email = new MimeMessage();
        email.From.Add(MailboxAddress.Parse(_settings.Email.From));
        email.To.Add(MailboxAddress.Parse(to));
        email.Subject = subject;

        var builder = new BodyBuilder { HtmlBody = htmlContent };
        email.Body = builder.ToMessageBody();

        if (TestAction != null)
        {
            await TestAction(email);
            return;
        }

        using var smtp = new SmtpClient();
        await smtp.ConnectAsync(_settings.Email.Smtp.Host, _settings.Email.Smtp.Port, _settings.Email.Smtp.UseSsl);
        await smtp.AuthenticateAsync(_settings.Email.Smtp.Username, _settings.Email.Smtp.Password);
        await smtp.SendAsync(email);
        await smtp.DisconnectAsync(true);
    }

    public async Task SendPasswordResetMail(User user)
    {
        _logger.LogDebug($"Sending password reset email to {user.Email}");
        var subject = "Password Reset";
        var content = $@"
            <h1>Password Reset Request</h1>
            <p>Dear {user.FirstName},</p>
            <p>You recently requested to reset your password. Click the link below to proceed:</p>
            <p><a href='{_settings.Email.BaseUrl}/account/reset/finish?key={user.ResetKey}'>Reset Password</a></p>
            <p>If you did not request this, please ignore this email.</p>";
        
        await SendEmailAsync(user.Email, subject, content);
    }

    public async Task SendActivationEmail(User user)
    {
        _logger.LogDebug($"Sending activation email to {user.Email}");
        var subject = "Activate Your Account";
        var content = $@"
            <h1>Account Activation</h1>
            <p>Dear {user.FirstName},</p>
            <p>Please click on the link below to activate your account:</p>
            <p><a href='{_settings.Email.BaseUrl}/account/activate?key={user.ActivationKey}'>Activate Account</a></p>";
        
        await SendEmailAsync(user.Email, subject, content);
    }

    public async Task SendCreationEmail(User user)
    {
        _logger.LogDebug($"Sending creation email to {user.Email}");
        var subject = "Welcome to Your Account";
        var content = $@"
            <h1>Welcome!</h1>
            <p>Dear {user.FirstName},</p>
            <p>Your account has been created successfully. Please click the link below to access your account:</p>
            <p><a href='{_settings.Email.BaseUrl}/login'>Login to Your Account</a></p>";
        
        await SendEmailAsync(user.Email, subject, content);
    }
}
